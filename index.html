<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LojinIC - Plataforma de Vendas</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Sistema de Erros -->
    <script>
        window.onerror = function(msg, url, line) {
            const div = document.getElementById('error-display');
            if(div) {
                div.style.display = 'block';
                div.innerHTML += `<p>Erro: ${msg}</p>`;
            }
            return false;
        };
    </script>

    <!-- Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .custom-loader {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="error-display" style="display:none; background:#fee2e2; color:#991b1b; padding:20px; margin:10px; border-radius:8px;"></div>

    <div id="root">
        <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif; color:#64748b;">
            <div class="custom-loader"></div>
            <p style="margin-top:15px;">Carregando LojinIC...</p>
        </div>
    </div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, GoogleAuthProvider, signInWithPopup } from 'firebase/auth';
        import { getDatabase, ref, push, set, get, update, remove, onValue, query, orderByChild, equalTo } from 'firebase/database';
        import { Store, ShoppingBag, Plus, Trash2, LogOut, ExternalLink, X, LayoutDashboard, ChevronRight, Package, MessageCircle, Settings, ShieldCheck, ArrowRight, Wallet, CheckCircle2, Lock, Zap, Smartphone, Globe, Copy, Search, AlertCircle } from 'lucide-react';

        // --- CONFIGURA칂츾O FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDvAcCedeELaoqybw64-DqZboSvtZqjH04",
            authDomain: "lojinic-99d2e.firebaseapp.com",
            databaseURL: "https://lojinic-99d2e-default-rtdb.firebaseio.com",
            projectId: "lojinic-99d2e",
            storageBucket: "lojinic-99d2e.firebasestorage.app",
            messagingSenderId: "170010365264",
            appId: "1:170010365264:web:94e1b369cd38ab9ed2b055"
        };

        // Inicializa칞칚o Segura
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getDatabase(app);
        } catch (error) {
            document.getElementById('error-display').innerHTML = "Erro Firebase: " + error.message;
            document.getElementById('error-display').style.display = 'block';
        }

        const APP_ID = 'lojinic-producao'; 
        const ADMIN_EMAIL = 'admin@lojinic.com';

        // --- UTILIT츼RIOS ---
        const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
        const getAvatar = (n) => `https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=0f172a&color=fff&bold=true`;
        const snapshotToArray = (snapshot) => {
            if (!snapshot || !snapshot.exists()) return [];
            const data = snapshot.val();
            return Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();
        };
        const copyText = (t) => {
            try { navigator.clipboard.writeText(t); } catch(e) { prompt("Copie a chave:", t); }
        };

        // --- COMPONENTE APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('landing');
            const [activeStoreId, setActiveStoreId] = useState(null);
            const [toast, setToast] = useState(null);
            const [longLoad, setLongLoad] = useState(false);

            useEffect(() => {
                let unsub = () => {};
                if (auth) {
                    unsub = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        setLoading(false);
                    });
                } else { setLoading(false); }

                // Tenta ler a URL inicial apenas, mas n칚o usa pushState depois
                try {
                    const params = new URLSearchParams(window.location.search);
                    const storeIdFromUrl = params.get('store');
                    if (storeIdFromUrl) {
                        setActiveStoreId(storeIdFromUrl);
                        setView('storefront');
                    }
                } catch (e) { console.log("Ambiente sem acesso  URL"); }

                const timer = setTimeout(() => { if(loading) setLongLoad(true); }, 3000);
                return () => { unsub(); clearTimeout(timer); };
            }, []);

            const forceEnter = () => setLoading(false);

            const showToast = (msg, type='success') => {
                setToast({msg, type}); setTimeout(() => setToast(null), 4000);
            };

            // NAVEGA칂츾O SEGURA (Sem pushState)
            const navigate = (targetView, storeId = null) => {
                setView(targetView);
                if (storeId) setActiveStoreId(storeId);
                // Removido window.history.pushState para evitar erro no blob/iframe
            };

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-50 p-4 text-center">
                    <div className="custom-loader mb-4"></div>
                    <p className="text-slate-500 font-medium mb-4">Conectando...</p>
                    {longLoad && (
                        <button onClick={forceEnter} className="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-slate-700 animate-fade-in">
                            Entrar Mesmo Assim
                        </button>
                    )}
                </div>
            );

            return (
                <>
                    {toast && (
                        <div className={`fixed top-5 right-5 z-[100] px-6 py-4 rounded-xl shadow-2xl text-white font-bold flex items-center gap-3 animate-bounce ${toast.type==='error'?'bg-red-500':'bg-emerald-600'}`}>
                            {toast.type==='error'?<AlertCircle size={20}/>:<CheckCircle2 size={20}/>} {toast.msg}
                        </div>
                    )}

                    {view === 'landing' && <LandingPage user={user} navigate={navigate} />}
                    {view === 'auth' && <AuthPage navigate={navigate} showToast={showToast} />}
                    {view === 'dashboard' && user && <Dashboard user={user} navigate={navigate} showToast={showToast} />}
                    {view === 'storefront' && activeStoreId && <Storefront storeId={activeStoreId} navigate={navigate} showToast={showToast} />}
                    {view === 'directory' && <Directory navigate={navigate} />}
                </>
            );
        }

        // --- COMPONENTES DE TELA ---

        function LandingPage({ user, navigate }) {
            return (
                <div className="min-h-screen bg-white flex flex-col">
                    <header className="bg-white/90 backdrop-blur border-b py-4 px-6 flex justify-between items-center sticky top-0 z-40">
                        <div className="flex items-center gap-2 font-black text-xl cursor-pointer select-none" onClick={()=>navigate('landing')}>
                            <div className="bg-slate-900 text-white p-1.5 rounded-lg"><ShoppingBag size={18}/></div> LojinIC
                        </div>
                        <div className="flex gap-2">
                            <button onClick={()=>navigate('directory')} className="text-sm font-bold text-slate-600 hover:text-blue-600 px-3 py-2">Lojas</button>
                            <button onClick={()=>navigate(user ? 'dashboard' : 'auth')} className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition">
                                {user ? 'Painel' : 'Entrar'}
                            </button>
                        </div>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center text-center px-4 py-10 animate-fade-in">
                        <span className="bg-blue-100 text-blue-700 text-xs font-bold px-4 py-1.5 rounded-full mb-6 uppercase tracking-wide border border-blue-200">Venda Online</span>
                        <h1 className="text-4xl md:text-6xl font-black text-slate-900 mb-6 tracking-tight">Sua loja pronta <br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">em segundos</span>.</h1>
                        <p className="text-slate-500 mb-8 max-w-md leading-relaxed">Crie seu cat치logo e receba pedidos no WhatsApp. R치pido, f치cil e seguro.</p>
                        <div className="flex gap-4">
                            <button onClick={()=>navigate(user ? 'dashboard' : 'auth')} className="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition transform active:scale-95">Criar Loja</button>
                            <button onClick={()=>navigate('directory')} className="bg-white text-slate-700 border px-6 py-3 rounded-xl font-bold hover:bg-slate-50 transition">Ver Lojas</button>
                        </div>
                    </main>
                </div>
            );
        }

        function AuthPage({ navigate, showToast }) {
            const [isReg, setIsReg] = useState(false);
            const [load, setLoad] = useState(false);
            const [f, setF] = useState({email:'', pass:'', name:''});

            const go = async (e) => {
                e.preventDefault(); setLoad(true);
                try {
                    if (!auth) throw new Error("Auth n칚o inicializado");
                    let u;
                    if(isReg) {
                        const c = await createUserWithEmailAndPassword(auth, f.email, f.pass);
                        u = c.user;
                        await updateProfile(u, {displayName: f.name});
                        await storeCheck(u, f.name);
                        showToast("Criado com sucesso!");
                    } else {
                        const c = await signInWithEmailAndPassword(auth, f.email, f.pass);
                        u = c.user;
                        showToast("Logado!");
                    }
                    navigate('dashboard');
                } catch(err) { showToast("Erro: " + err.message, "error"); } 
                finally { setLoad(false); }
            };

            const google = async () => {
                try {
                    const r = await signInWithPopup(auth, new GoogleAuthProvider());
                    await storeCheck(r.user, r.user.displayName);
                    navigate('dashboard');
                } catch(e) { showToast("Erro Google: " + e.message, "error"); }
            };

            const storeCheck = async (u, n) => {
                const refS = ref(db, `artifacts/${APP_ID}/public/data/stores`);
                const q = query(refS, orderByChild('ownerId'), equalTo(u.uid));
                const snap = await get(q);
                if(!snap.exists()) {
                    await set(push(refS), {
                        ownerId: u.uid, name: n || "Loja", whatsapp:"", themeColor:"#1e293b", 
                        logoUrl: getAvatar(n), paymentStatus:'pending', createdAt: Date.now()
                    });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4 animate-fade-in">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <h2 className="text-2xl font-bold text-center mb-6 text-slate-800">{isReg ? 'Criar' : 'Entrar'}</h2>
                        <form onSubmit={go} className="space-y-3">
                            {isReg && <input className="w-full border p-3 rounded-lg outline-none focus:border-blue-500 transition" placeholder="Nome Loja" value={f.name} onChange={e=>setF({...f, name:e.target.value})} required/>}
                            <input className="w-full border p-3 rounded-lg outline-none focus:border-blue-500 transition" type="email" placeholder="Email" value={f.email} onChange={e=>setF({...f, email:e.target.value})} required/>
                            <input className="w-full border p-3 rounded-lg outline-none focus:border-blue-500 transition" type="password" placeholder="Senha" value={f.pass} onChange={e=>setF({...f, pass:e.target.value})} required/>
                            <button disabled={load} className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition">{load?'...':'Confirmar'}</button>
                        </form>
                        <button onClick={google} className="w-full border py-3 rounded-lg font-bold mt-4 flex justify-center gap-2 hover:bg-slate-50 transition"><Globe size={20}/> Google</button>
                        <button onClick={()=>setIsReg(!isReg)} className="block mx-auto mt-4 text-blue-600 text-sm hover:underline">{isReg?'J치 tenho conta':'Criar conta'}</button>
                        <button onClick={()=>navigate('landing')} className="block mx-auto mt-2 text-slate-400 text-xs hover:text-slate-600">Cancelar</button>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, navigate, showToast }) {
            const [store, setStore] = useState(null);
            const [tab, setTab] = useState('prod');
            const [prods, setProds] = useState([]);
            const [newP, setNewP] = useState({name:'', price:'', img:''});
            
            const isAdmin = user.email === ADMIN_EMAIL;
            const [allStores, setAllStores] = useState([]);
            const [pix, setPix] = useState('');

            useEffect(() => {
                if (!db) return;
                if(isAdmin) {
                    onValue(ref(db, `artifacts/${APP_ID}/public/data/stores`), s => setAllStores(snapshotToArray(s)));
                    get(ref(db, `artifacts/${APP_ID}/public/data/saas_config`)).then(s => s.exists() && setPix(s.val().pixKey));
                } else {
                    const q = query(ref(db, `artifacts/${APP_ID}/public/data/stores`), orderByChild('ownerId'), equalTo(user.uid));
                    onValue(q, s => {
                        if(s.exists()) {
                            const d = s.val(); const k = Object.keys(d)[0];
                            setStore({id:k, ...d[k]});
                            get(ref(db, `artifacts/${APP_ID}/public/data/saas_config`)).then(sc => sc.exists() && setPix(sc.val().pixKey));
                        }
                    });
                }
            }, [user]);

            useEffect(() => {
                if(store) {
                    const q = query(ref(db, `artifacts/${APP_ID}/public/data/products`), orderByChild('storeId'), equalTo(store.id));
                    onValue(q, s => setProds(snapshotToArray(s)));
                }
            }, [store]);

            const addP = async (e) => {
                e.preventDefault();
                const img = newP.img || `https://source.unsplash.com/featured/?${newP.name},product&t=${Date.now()}`;
                await set(push(ref(db, `artifacts/${APP_ID}/public/data/products`)), {
                    storeId: store.id, name: newP.name, price: parseFloat(newP.price), image: img, createdAt: Date.now()
                });
                setNewP({name:'', price:'', img:''}); showToast("Produto criado!");
            };
            const delP = async (id) => { if(confirm('Excluir?')) await remove(ref(db, `artifacts/${APP_ID}/public/data/products/${id}`)); };
            const saveConf = async (e) => {
                e.preventDefault();
                await update(ref(db, `artifacts/${APP_ID}/public/data/stores/${store.id}`), {
                    name: e.target.name.value, whatsapp: e.target.whatsapp.value, themeColor: e.target.color.value
                }); showToast("Salvo!");
            };
            
            const toggleSt = async (id, st) => update(ref(db, `artifacts/${APP_ID}/public/data/stores/${id}`), {paymentStatus: st==='active'?'pending':'active'});
            const savePix = async () => { await update(ref(db, `artifacts/${APP_ID}/public/data/saas_config`), {pixKey: pix}); showToast("Pix Salvo"); };

            if(isAdmin) return (
                <div className="min-h-screen bg-slate-900 text-white p-4 animate-fade-in">
                    <div className="flex justify-between mb-6 border-b border-slate-700 pb-2">
                        <h2 className="text-xl font-bold flex gap-2 items-center"><LayoutDashboard/> Admin Master</h2>
                        <button onClick={()=>signOut(auth)} className="text-red-400 text-sm font-bold">Sair</button>
                    </div>
                    <div className="mb-6 bg-slate-800 p-4 rounded-lg border border-slate-700">
                        <h3 className="font-bold mb-2 flex items-center gap-2"><Wallet size={16}/> Pix Global</h3>
                        <div className="flex gap-2"><input className="bg-slate-900 border-slate-600 border p-2 rounded w-full text-white" value={pix} onChange={e=>setPix(e.target.value)}/><button onClick={savePix} className="bg-blue-600 px-4 rounded font-bold hover:bg-blue-500">Salvar</button></div>
                    </div>
                    <div className="space-y-2">
                        {allStores.map(s => (
                            <div key={s.id} className="bg-slate-800 p-3 rounded-lg flex justify-between items-center border border-slate-700">
                                <div><b>{s.name}</b> <span className={`text-xs ml-2 font-bold uppercase ${s.paymentStatus==='active'?'text-green-400':'text-amber-500'}`}>{s.paymentStatus}</span></div>
                                <div className="flex gap-2">
                                    <button onClick={()=>navigate('storefront', s.id)} className="p-1 bg-slate-700 rounded hover:bg-slate-600"><ExternalLink size={16}/></button>
                                    <button onClick={()=>toggleSt(s.id, s.paymentStatus)} className={`text-xs border px-2 py-1 rounded font-bold ${s.paymentStatus==='active'?'border-red-500 text-red-400':'border-green-500 text-green-400'}`}>{s.paymentStatus==='active'?'Bloquear':'Aprovar'}</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            if(!store) return <div className="p-10 text-center text-slate-400">Carregando loja...</div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-20 animate-fade-in">
                    <header className="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-2"><img src={store.logoUrl} className="w-8 h-8 rounded-lg object-cover"/> <span className="font-bold text-sm">{store.name}</span></div>
                        <div className="flex gap-2"><button onClick={()=>navigate('storefront', store.id)} className="text-blue-600 text-sm font-bold flex items-center gap-1 hover:bg-blue-50 px-2 py-1 rounded"><ExternalLink size={14}/> Ver Loja</button><button onClick={()=>signOut(auth)}><LogOut size={18} className="text-slate-400 hover:text-red-500"/></button></div>
                    </header>
                    <div className="p-4 max-w-2xl mx-auto">
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-1">
                            {[{k:'prod',l:'Produtos'},{k:'sub',l:'Assinatura'},{k:'conf',l:'Ajustes'}].map(x=>(
                                <button key={x.k} onClick={()=>setTab(x.k)} className={`px-4 py-2 rounded-full text-sm font-bold transition ${tab===x.k?'bg-slate-900 text-white shadow-lg':'bg-white border hover:bg-slate-50'}`}>{x.l}</button>
                            ))}
                        </div>

                        {tab==='prod' && (
                            store.paymentStatus!=='active' ? <div className="bg-white p-8 rounded-xl text-center shadow border border-slate-100"><Lock className="mx-auto mb-2 text-amber-500" size={32}/><h3 className="font-bold text-lg">Loja Bloqueada</h3><p className="text-slate-500 text-sm mb-4">Pague a assinatura para desbloquear.</p><button onClick={()=>setTab('sub')} className="text-blue-600 font-bold underline">Resolver</button></div> :
                            <div className="animate-slide-up">
                                <form onSubmit={addP} className="bg-white p-4 rounded-xl shadow mb-4 grid grid-cols-2 gap-3 border border-slate-100">
                                    <input className="border p-2 rounded-lg col-span-2 outline-none focus:border-blue-500" placeholder="Nome do Produto" value={newP.name} onChange={e=>setNewP({...newP, name:e.target.value})} required/>
                                    <input className="border p-2 rounded-lg outline-none focus:border-blue-500" type="number" placeholder="Pre칞o (R$)" value={newP.price} onChange={e=>setNewP({...newP, price:e.target.value})} required/>
                                    <input className="border p-2 rounded-lg outline-none focus:border-blue-500" placeholder="Link Imagem (Opcional)" value={newP.img} onChange={e=>setNewP({...newP, img:e.target.value})}/>
                                    <button className="bg-slate-900 text-white col-span-2 py-2.5 rounded-lg font-bold hover:bg-slate-800 transition">Adicionar Produto</button>
                                </form>
                                <div className="space-y-3">
                                    {prods.map(p=>(<div key={p.id} className="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-3"><img src={p.image} className="w-14 h-14 rounded-lg object-cover"/><div className="flex-1"><b className="text-slate-800">{p.name}</b><div className="text-green-600 font-bold text-sm">{formatBRL(p.price)}</div></div><button onClick={()=>delP(p.id)} className="p-2 bg-red-50 text-red-400 rounded-lg hover:bg-red-100"><Trash2 size={16}/></button></div>))}
                                    {prods.length===0 && <div className="text-center text-slate-400 py-8">Nenhum produto cadastrado.</div>}
                                </div>
                            </div>
                        )}

                        {tab==='sub' && (
                            <div className="bg-white p-6 rounded-xl shadow text-center border border-slate-100 animate-slide-up">
                                <div className="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3"><Wallet size={24}/></div>
                                <h3 className="font-bold text-lg">Assinatura: <span className={store.paymentStatus==='active'?'text-green-600':'text-amber-500'}>{store.paymentStatus==='active'?'ATIVA':'PENDENTE'}</span></h3>
                                <div className="bg-slate-50 p-4 rounded-xl border my-4">
                                    <p className="text-xs text-slate-400 uppercase font-bold mb-2">Chave Pix</p>
                                    <div onClick={()=>{copyText(pix); showToast("Copiado!")}} className="font-mono text-sm bg-white p-2 rounded border cursor-pointer hover:border-blue-400 flex items-center justify-center gap-2">{pix||"Aguardando Admin"} <Copy size={14}/></div>
                                </div>
                                <p className="text-xs text-slate-500">Realize o pagamento e envie o comprovante ao suporte.</p>
                            </div>
                        )}

                        {tab==='conf' && (
                            <form onSubmit={saveConf} className="bg-white p-6 rounded-xl shadow space-y-4 border border-slate-100 animate-slide-up">
                                <div><label className="text-xs font-bold text-slate-400 uppercase">Nome</label><input name="name" defaultValue={store.name} className="w-full border p-2 rounded-lg outline-none focus:border-blue-500"/></div>
                                <div><label className="text-xs font-bold text-slate-400 uppercase">WhatsApp (S칩 n칰meros)</label><input name="whatsapp" defaultValue={store.whatsapp} className="w-full border p-2 rounded-lg outline-none focus:border-blue-500"/></div>
                                <div><label className="text-xs font-bold text-slate-400 uppercase">Cor</label><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border"><input name="color" type="color" defaultValue={store.themeColor} className="w-8 h-8 rounded cursor-pointer border-none bg-transparent"/><span className="text-sm text-slate-500">Cor do Tema</span></div></div>
                                <button className="w-full bg-slate-900 text-white py-3 rounded-lg font-bold hover:bg-slate-800 transition">Salvar Altera칞칫es</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        }

        function Storefront({ storeId, navigate, showToast }) {
            const [s, setS] = useState(null);
            const [p, setP] = useState([]);
            const [c, setC] = useState([]);
            const [cartOpen, setCartOpen] = useState(false);
            const [chk, setChk] = useState({n:'', m:'Pix'});

            useEffect(() => {
                if(!storeId || !db) return;
                onValue(ref(db, `artifacts/${APP_ID}/public/data/stores/${storeId}`), snap => snap.exists() && setS({id:snap.key, ...snap.val()}));
                onValue(query(ref(db, `artifacts/${APP_ID}/public/data/products`), orderByChild('storeId'), equalTo(storeId)), snap => setP(snapshotToArray(snap)));
            }, [storeId]);

            const add = (x) => { setC([...c, x]); showToast("Adicionado!"); setCartOpen(true); };
            const rem = (i) => setC(c.filter((_,idx)=>idx!==i));
            const tot = c.reduce((a,b)=>a+b.price,0);
            const end = () => {
                if(!s.whatsapp) return showToast("Loja sem WhatsApp", "error");
                if(!chk.n) return showToast("Nome obrigat칩rio", "error");
                const m = `*PEDIDO ${s.name}*\n游녻 ${chk.n}\n游눱 ${chk.m}\n--\n${c.map(i=>`1x ${i.name}`).join('\n')}\n--\nTotal: ${formatBRL(tot)}`;
                window.open(`https://wa.me/${s.whatsapp}?text=${encodeURIComponent(m)}`);
                setC([]); setCartOpen(false);
            };

            if(!s) return <div className="p-10 text-center bg-slate-50 h-screen flex items-center justify-center"><div className="custom-loader"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-20 animate-fade-in">
                    <nav className="bg-white sticky top-0 z-30 px-4 h-16 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2"><img src={s.logoUrl} className="w-8 h-8 rounded-lg object-cover"/><span className="font-bold text-slate-800">{s.name}</span></div>
                        <div className="flex gap-2">
                            <button onClick={()=>navigate('landing')} className="p-2 bg-slate-100 rounded-full"><X size={20} className="text-slate-500"/></button>
                            <button onClick={()=>setCartOpen(true)} className="relative p-2 bg-slate-100 rounded-full"><ShoppingBag size={20} className="text-slate-700"/><span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-4 h-4 rounded-full flex items-center justify-center font-bold">{c.length}</span></button>
                        </div>
                    </nav>
                    <div style={{backgroundColor:s.themeColor}} className="h-32 w-full"></div>
                    <div className="px-4 -mt-10 grid grid-cols-2 gap-4">
                        {p.map(x=>(
                            <div key={x.id} className="bg-white rounded-xl shadow overflow-hidden flex flex-col border border-slate-100 hover:shadow-md transition">
                                <img src={x.image} className="h-32 object-cover w-full"/>
                                <div className="p-3 flex-1 flex flex-col">
                                    <div className="font-bold text-sm leading-tight mb-1 text-slate-800">{x.name}</div>
                                    <div className="mt-auto flex justify-between items-center pt-2 border-t border-slate-50">
                                        <span className="font-bold text-slate-900">{formatBRL(x.price)}</span>
                                        <button onClick={()=>add(x)} style={{backgroundColor:s.themeColor}} className="text-white p-1.5 rounded-lg shadow active:scale-95 transition"><Plus size={16}/></button>
                                    </div>
                                </div>
                            </div>
                        ))}
                        {p.length===0 && <div className="col-span-2 text-center py-10 text-slate-400 bg-white rounded-xl shadow-sm">Loja vazia.</div>}
                    </div>
                    {cartOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end isolate">
                            <div className="absolute inset-0 bg-black/30 backdrop-blur-sm transition-opacity" onClick={()=>setCartOpen(false)}></div>
                            <div className="bg-white w-full max-w-sm z-10 h-full flex flex-col p-0 animate-slide-up">
                                <div className="flex justify-between items-center p-4 border-b bg-slate-50"><h2 className="font-bold text-lg flex gap-2 items-center"><ShoppingBag size={20}/> Carrinho</h2><button onClick={()=>setCartOpen(false)} className="p-1 hover:bg-slate-200 rounded-full"><X/></button></div>
                                <div className="flex-1 overflow-y-auto space-y-3 p-4">
                                    {c.length===0 ? <div className="text-center text-slate-400 mt-10">Carrinho vazio.</div> : 
                                    c.map((x,i)=>(<div key={i} className="flex justify-between border p-3 rounded-xl items-center shadow-sm bg-white">
                                        <div className="flex items-center gap-3"><img src={x.image} className="w-10 h-10 rounded object-cover"/><div><div className="text-sm font-bold">{x.name}</div><div className="text-xs text-slate-500">{formatBRL(x.price)}</div></div></div>
                                        <button onClick={()=>rem(i)} className="text-red-400 p-2 hover:bg-red-50 rounded"><Trash2 size={16}/></button>
                                    </div>))}
                                </div>
                                <div className="p-4 border-t bg-slate-50">
                                    <div className="flex justify-between font-bold text-xl mb-4 text-slate-800"><span>Total</span><span>{formatBRL(tot)}</span></div>
                                    {c.length>0 && <div className="space-y-3">
                                        <input className="border p-3 w-full rounded-xl outline-none focus:border-blue-500" placeholder="Seu Nome" onChange={e=>setChk({...chk,n:e.target.value})}/>
                                        <select className="border p-3 w-full rounded-xl bg-white" onChange={e=>setChk({...chk,m:e.target.value})}><option>Pix</option><option>Dinheiro</option><option>Cart칚o</option></select>
                                        <button onClick={end} className="w-full bg-green-500 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-green-600 transition flex justify-center gap-2 items-center"><MessageCircle size={20}/> Enviar Pedido</button>
                                    </div>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function Directory({ navigate }) {
            const [list, setList] = useState([]);
            useEffect(() => {
                if(db) onValue(ref(db, `artifacts/${APP_ID}/public/data/stores`), s => setList(snapshotToArray(s)));
            }, []);
            return (
                <div className="min-h-screen bg-slate-50 p-4 animate-fade-in">
                    <div className="flex gap-4 mb-6 items-center"><button onClick={()=>navigate('landing')} className="bg-white p-2 rounded-lg shadow text-slate-600"><ChevronRight className="rotate-180"/></button><h1 className="text-2xl font-bold text-slate-800">Lojas</h1></div>
                    <div className="grid grid-cols-2 gap-4">
                        {list.map(s=>(<div key={s.id} onClick={()=>navigate('storefront', s.id)} className="bg-white p-4 rounded-2xl shadow-sm hover:shadow-md transition flex flex-col items-center text-center cursor-pointer border border-slate-100 group">
                            <img src={s.logoUrl} className="w-16 h-16 rounded-xl mb-3 bg-slate-100 object-cover group-hover:scale-105 transition duration-500"/>
                            <b className="text-slate-800">{s.name}</b>
                            {s.paymentStatus==='active' && <span className="text-[10px] text-green-600 bg-green-50 px-2 py-0.5 rounded mt-1 font-bold">Verificado</span>}
                        </div>))}
                        {list.length===0 && <div className="col-span-2 text-center text-slate-400 py-10">Nenhuma loja encontrada.</div>}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
