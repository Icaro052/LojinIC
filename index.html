<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LojinIC - Sua Loja Online</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out', 'slide-up': 'slideUp 0.3s ease-out' },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- √çcones e Fontes -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Import Map (React + Firebase Realtime Database) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased selection:bg-blue-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, GoogleAuthProvider, signInWithPopup } from 'firebase/auth';
        import { getDatabase, ref, push, set, get, update, remove, onValue, query, orderByChild, equalTo } from 'firebase/database';
        import { Store, ShoppingBag, Plus, Trash2, LogOut, ExternalLink, X, LayoutDashboard, ChevronRight, Package, MessageCircle, Settings, ShieldCheck, ArrowRight, Wallet, CheckCircle2, Lock, Zap, Smartphone, Globe, Copy, Search, AlertCircle } from 'lucide-react';

        // --- SEUS DADOS FIREBASE (RTDB) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDvAcCedeELaoqybw64-DqZboSvtZqjH04",
            authDomain: "lojinic-99d2e.firebaseapp.com",
            databaseURL: "https://lojinic-99d2e-default-rtdb.firebaseio.com",
            projectId: "lojinic-99d2e",
            storageBucket: "lojinic-99d2e.firebasestorage.app",
            messagingSenderId: "170010365264",
            appId: "1:170010365264:web:94e1b369cd38ab9ed2b055",
            measurementId: "G-0WY10W9CLN"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // --- CONSTANTES GLOBAIS ---
        const APP_ID = 'lojinic-producao'; 
        const ADMIN_EMAIL = 'admin@lojinic.com';

        // --- UTILIT√ÅRIOS ---
        const formatBRL = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
        const getAvatar = (n) => `https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=0f172a&color=fff&bold=true`;
        const copyText = (t) => {
            if(navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(t);
            } else {
                const el = document.createElement('textarea'); el.value = t; el.style.position='fixed'; 
                document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            }
        };
        const snapshotToArray = (snapshot) => {
            if (!snapshot.exists()) return [];
            const data = snapshot.val();
            return Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('landing');
            const [activeStoreId, setActiveStoreId] = useState(null);
            const [toast, setToast] = useState(null);

            const showToast = (msg, type='success') => {
                setToast({msg, type}); setTimeout(() => setToast(null), 4000);
            };

            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u); setLoading(false);
                });
                const params = new URLSearchParams(window.location.search);
                const storeIdFromUrl = params.get('store');
                if (storeIdFromUrl) {
                    setActiveStoreId(storeIdFromUrl);
                    setView('storefront');
                }
                return () => unsub();
            }, []);

            const navigate = (targetView, storeId = null) => {
                setView(targetView);
                if (storeId) setActiveStoreId(storeId);
                const url = storeId ? `?store=${storeId}` : window.location.pathname;
                window.history.pushState({}, '', url);
            };

            if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50"><div className="w-12 h-12 border-4 border-slate-800 border-t-blue-500 rounded-full animate-spin"></div></div>;

            return (
                <>
                    {toast && (
                        <div className={`fixed top-5 right-5 z-[100] px-6 py-4 rounded-xl shadow-2xl text-white font-bold animate-fade-in flex items-center gap-3 ${toast.type==='error'?'bg-red-500':'bg-emerald-600'}`}>
                            {toast.type==='error'?<AlertCircle size={20}/>:<CheckCircle2 size={20}/>} {toast.msg}
                        </div>
                    )}

                    {view === 'landing' && <LandingPage user={user} navigate={navigate} />}
                    {view === 'auth' && <AuthPage navigate={navigate} showToast={showToast} />}
                    {view === 'dashboard' && user && <Dashboard user={user} navigate={navigate} showToast={showToast} />}
                    {view === 'storefront' && activeStoreId && <Storefront storeId={activeStoreId} navigate={navigate} showToast={showToast} />}
                    {view === 'directory' && <Directory navigate={navigate} />}
                </>
            );
        }

        // --- 1. LANDING PAGE ---
        function LandingPage({ user, navigate }) {
            return (
                <div className="min-h-screen bg-white flex flex-col">
                    <header className="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b py-4 px-6 flex justify-between items-center">
                        <div className="flex items-center gap-2 font-black text-xl tracking-tighter cursor-pointer select-none" onClick={()=>navigate('landing')}>
                            <div className="bg-slate-900 text-white p-1.5 rounded-lg"><ShoppingBag size={18}/></div> LojinIC
                        </div>
                        <div className="flex gap-3">
                            <button onClick={()=>navigate('directory')} className="text-sm font-bold text-slate-600 hover:text-blue-600 flex items-center gap-1"><Search size={16}/> Lojas</button>
                            {user ? 
                                <button onClick={()=>navigate('dashboard')} className="bg-slate-900 text-white px-5 py-2 rounded-full text-sm font-bold shadow-lg shadow-slate-200 hover:bg-slate-800 transition">Painel</button> :
                                <button onClick={()=>navigate('auth')} className="bg-blue-600 text-white px-5 py-2 rounded-full text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100">Entrar</button>
                            }
                        </div>
                    </header>
                    <main className="flex-1 flex flex-col items-center justify-center text-center px-4 py-20 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-blue-50 via-white to-white">
                        <span className="bg-blue-100 text-blue-700 text-xs font-bold px-4 py-1.5 rounded-full mb-8 uppercase tracking-wider border border-blue-200">Plataforma de Vendas Online</span>
                        <h1 className="text-5xl md:text-7xl font-black text-slate-900 mb-6 leading-tight tracking-tight">Sua loja pronta <br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-cyan-500">em segundos</span>.</h1>
                        <p className="text-lg text-slate-500 max-w-2xl mb-12 leading-relaxed">Crie seu cat√°logo digital profissional gratuitamente. Receba pedidos organizados diretamente no seu WhatsApp.</p>
                        <div className="flex flex-col sm:flex-row gap-4 w-full justify-center">
                            <button onClick={()=>navigate(user ? 'dashboard' : 'auth')} className="bg-slate-900 text-white px-8 py-4 rounded-2xl font-bold text-lg shadow-xl shadow-slate-900/20 hover:scale-105 transition transform flex items-center justify-center gap-2">
                                Criar Minha Loja <ArrowRight size={20}/>
                            </button>
                            <button onClick={()=>navigate('directory')} className="bg-white text-slate-700 border border-slate-200 px-8 py-4 rounded-2xl font-bold text-lg hover:bg-slate-50 transition flex items-center justify-center gap-2">
                                Ver Exemplos
                            </button>
                        </div>
                    </main>
                    <div className="bg-slate-50 py-20 border-t border-slate-100">
                        <div className="max-w-5xl mx-auto px-4 grid md:grid-cols-3 gap-8">
                            {[
                                {icon: Smartphone, title: "100% Mobile", txt: "Gerencie seus produtos e pedidos pelo celular."},
                                {icon: MessageCircle, title: "WhatsApp", txt: "Checkout direto no Zap. Sem taxas intermedi√°rias."},
                                {icon: Lock, title: "Seguro", txt: "Infraestrutura Google Realtime Database."}
                            ].map((i,k)=>(
                                <div key={k} className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200/50 text-center hover:shadow-md transition">
                                    <div className="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4"><i.icon size={28}/></div>
                                    <h3 className="font-bold text-lg mb-2 text-slate-900">{i.title}</h3>
                                    <p className="text-slate-500 text-sm leading-relaxed">{i.txt}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- 2. AUTENTICA√á√ÉO ---
        function AuthPage({ navigate, showToast }) {
            const [isRegister, setIsRegister] = useState(false);
            const [loading, setLoading] = useState(false);
            const [form, setForm] = useState({email:'', pass:'', name:''});

            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true);
                try {
                    let user;
                    if(isRegister) {
                        const cred = await createUserWithEmailAndPassword(auth, form.email, form.pass);
                        user = cred.user;
                        await updateProfile(user, {displayName: form.name});
                        await checkOrCreateStore(user, form.name);
                        showToast("Conta criada com sucesso!");
                    } else {
                        const cred = await signInWithEmailAndPassword(auth, form.email, form.pass);
                        user = cred.user;
                        showToast("Bem-vindo de volta!");
                    }
                    navigate('dashboard');
                } catch(err) {
                    console.error(err);
                    let msg = "Erro ao autenticar.";
                    if(err.code === 'auth/invalid-credential') msg = "Dados incorretos.";
                    if(err.code === 'auth/email-already-in-use') msg = "E-mail j√° cadastrado.";
                    showToast(msg, "error");
                } finally { setLoading(false); }
            };

            const handleGoogle = async () => {
                try {
                    const res = await signInWithPopup(auth, new GoogleAuthProvider());
                    await checkOrCreateStore(res.user, res.user.displayName);
                    navigate('dashboard');
                } catch(e) { showToast("Login com Google cancelado ou falhou.", "error"); }
            };

            const checkOrCreateStore = async (u, name) => {
                const storesRef = ref(db, `artifacts/${APP_ID}/public/data/stores`);
                const q = query(storesRef, orderByChild('ownerId'), equalTo(u.uid));
                const snapshot = await get(q);
                
                if (!snapshot.exists()) {
                    const newStoreRef = push(storesRef);
                    await set(newStoreRef, {
                        ownerId: u.uid,
                        name: name || "Minha Loja",
                        whatsapp: "",
                        themeColor: "#0f172a",
                        logoUrl: getAvatar(name),
                        paymentStatus: 'pending',
                        createdAt: Date.now()
                    });
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50 px-4 py-12">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-md animate-slide-up relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-500 to-cyan-500"></div>
                        <h2 className="text-2xl font-bold text-center mb-8 text-slate-800">{isRegister ? 'Comece Agora' : 'Bem-vindo de Volta'}</h2>
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            {isRegister && (
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase ml-1">Nome da Loja</label>
                                    <input required className="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl outline-none focus:border-blue-500 transition" placeholder="Ex: Loja do Jo√£o" value={form.name} onChange={e=>setForm({...form, name:e.target.value})}/>
                                </div>
                            )}
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">E-mail</label>
                                <input required type="email" className="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl outline-none focus:border-blue-500 transition" placeholder="seu@email.com" value={form.email} onChange={e=>setForm({...form, email:e.target.value})}/>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase ml-1">Senha</label>
                                <input required type="password" className="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl outline-none focus:border-blue-500 transition" placeholder="******" value={form.pass} onChange={e=>setForm({...form, pass:e.target.value})}/>
                            </div>
                            <button disabled={loading} className="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold hover:bg-slate-800 transition shadow-lg disabled:opacity-50">
                                {loading ? 'Processando...' : (isRegister ? 'Criar Conta Gr√°tis' : 'Acessar Painel')}
                            </button>
                        </form>

                        <div className="my-8 flex items-center"><div className="flex-1 border-t border-slate-100"></div><span className="px-3 text-xs text-slate-400 font-bold uppercase">Ou</span><div className="flex-1 border-t border-slate-100"></div></div>

                        <button onClick={handleGoogle} className="w-full border-2 border-slate-100 py-3 rounded-xl font-bold text-slate-600 hover:bg-slate-50 hover:border-slate-200 flex items-center justify-center gap-2 transition">
                            <Globe size={18} className="text-blue-500"/> Continuar com Google
                        </button>
                        
                        <p className="text-center text-sm text-slate-500 mt-8">
                            {isRegister ? 'J√° possui conta?' : 'Novo por aqui?'}
                            <button onClick={()=>setIsRegister(!isRegister)} className="text-blue-600 font-bold ml-1 hover:underline">{isRegister ? 'Fazer Login' : 'Cadastre-se'}</button>
                        </p>
                        <button onClick={()=>navigate('landing')} className="block mx-auto mt-6 text-xs text-slate-400 hover:text-slate-600 font-bold uppercase tracking-wide">Voltar ao in√≠cio</button>
                    </div>
                </div>
            );
        }

        // --- 3. DASHBOARD ---
        function Dashboard({ user, navigate, showToast }) {
            const isAdmin = user.email === ADMIN_EMAIL;
            const [store, setStore] = useState(null);
            const [products, setProducts] = useState([]);
            const [tab, setTab] = useState('products');
            const [adding, setAdding] = useState(false);
            const [newProd, setNewProd] = useState({name:'', price:'', img:''});
            const [adminStores, setAdminStores] = useState([]);
            const [pixKey, setPixKey] = useState('');

            useEffect(() => {
                if(isAdmin) {
                    const storesRef = ref(db, `artifacts/${APP_ID}/public/data/stores`);
                    const unsub1 = onValue(storesRef, (snap) => setAdminStores(snapshotToArray(snap)));
                    const configRef = ref(db, `artifacts/${APP_ID}/public/data/saas_config`);
                    get(configRef).then(snap => { if(snap.exists()) setPixKey(snap.val().pixKey || ''); });
                    return () => unsub1();
                } else {
                    const storesRef = ref(db, `artifacts/${APP_ID}/public/data/stores`);
                    const q = query(storesRef, orderByChild('ownerId'), equalTo(user.uid));
                    const unsub2 = onValue(q, (snap) => {
                        if(snap.exists()) {
                            const data = snap.val();
                            const key = Object.keys(data)[0];
                            setStore({id: key, ...data[key]});
                            const configRef = ref(db, `artifacts/${APP_ID}/public/data/saas_config`);
                            get(configRef).then(s => { if(s.exists()) setPixKey(s.val().pixKey); });
                        }
                    });
                    return () => unsub2();
                }
            }, [user]);

            useEffect(() => {
                if(store) {
                    const productsRef = ref(db, `artifacts/${APP_ID}/public/data/products`);
                    const q = query(productsRef, orderByChild('storeId'), equalTo(store.id));
                    const unsub = onValue(q, (snap) => setProducts(snapshotToArray(snap)));
                    return () => unsub();
                }
            }, [store]);

            const saveProduct = async (e) => {
                e.preventDefault();
                try {
                    const img = newProd.img.trim() || `https://source.unsplash.com/featured/?${newProd.name},product&t=${Date.now()}`;
                    const productsRef = ref(db, `artifacts/${APP_ID}/public/data/products`);
                    const newRef = push(productsRef);
                    await set(newRef, {
                        storeId: store.id, name: newProd.name, price: parseFloat(newProd.price), image: img, createdAt: Date.now()
                    });
                    setAdding(false); setNewProd({name:'', price:'', img:''}); showToast("Produto adicionado!");
                } catch(e) { showToast("Erro ao salvar", "error"); }
            };

            const deleteProduct = async (id) => {
                if(confirm("Tem certeza que deseja excluir este produto?")) { 
                    await remove(ref(db, `artifacts/${APP_ID}/public/data/products/${id}`)); 
                    showToast("Produto exclu√≠do."); 
                }
            };

            const saveSettings = async (e) => {
                e.preventDefault();
                await update(ref(db, `artifacts/${APP_ID}/public/data/stores/${store.id}`), {
                    name: e.target.name.value, whatsapp: e.target.whatsapp.value.replace(/\D/g,''), themeColor: e.target.color.value
                });
                showToast("Loja atualizada com sucesso!");
            };

            const toggleStoreStatus = async (id, status) => {
                await update(ref(db, `artifacts/${APP_ID}/public/data/stores/${id}`), { paymentStatus: status === 'active' ? 'pending' : 'active' });
            };
            const saveAdminPix = async () => {
                await update(ref(db, `artifacts/${APP_ID}/public/data/saas_config`), { pixKey });
                showToast("Chave Pix Global Salva!");
            };

            if(isAdmin) {
                return (
                    <div className="min-h-screen bg-slate-900 text-slate-100 p-6 font-sans">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex justify-between items-center mb-8 pb-4 border-b border-slate-700">
                                <h1 className="text-2xl font-bold flex gap-2 items-center"><LayoutDashboard/> Admin Master</h1>
                                <button onClick={()=>signOut(auth)} className="bg-red-500/10 text-red-400 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-500/20 transition">Sair</button>
                            </div>
                            <div className="grid md:grid-cols-3 gap-6">
                                <div className="md:col-span-1 bg-slate-800 p-6 rounded-2xl h-fit border border-slate-700">
                                    <h3 className="font-bold mb-4 flex items-center gap-2 text-blue-400"><Wallet size={18}/> Chave Pix Global</h3>
                                    <input className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 mb-3 text-white outline-none focus:border-blue-500 transition" value={pixKey} onChange={e=>setPixKey(e.target.value)} placeholder="Chave Pix"/>
                                    <button onClick={saveAdminPix} className="w-full bg-blue-600 hover:bg-blue-500 py-2 rounded-lg font-bold transition">Salvar</button>
                                </div>
                                <div className="md:col-span-2 bg-slate-800 p-6 rounded-2xl border border-slate-700">
                                    <h3 className="font-bold mb-4 text-emerald-400">Lojas Cadastradas ({adminStores.length})</h3>
                                    <div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                                        {adminStores.map(s => (
                                            <div key={s.id} className="flex justify-between items-center bg-slate-900 p-4 rounded-xl border border-slate-700/50 hover:border-slate-600 transition">
                                                <div>
                                                    <div className="font-bold text-white">{s.name}</div>
                                                    <div className={`text-xs font-bold uppercase mt-1 ${s.paymentStatus==='active'?'text-green-400':'text-amber-500'}`}>{s.paymentStatus}</div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>navigate('storefront', s.id)} className="p-2 bg-slate-800 rounded-lg hover:bg-slate-700 text-slate-400 hover:text-white"><ExternalLink size={16}/></button>
                                                    <button onClick={()=>toggleStoreStatus(s.id, s.paymentStatus)} className={`px-3 py-2 rounded-lg font-bold text-xs transition ${s.paymentStatus==='active'?'bg-red-500/20 text-red-400 hover:bg-red-500/30':'bg-green-500/20 text-green-400 hover:bg-green-500/30'}`}>
                                                        {s.paymentStatus==='active' ? 'Bloquear' : 'Aprovar'}
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if(!store) return <div className="h-screen flex items-center justify-center text-slate-400 bg-slate-50"><div className="animate-spin rounded-full border-4 border-slate-200 border-t-slate-800 w-10 h-10"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 pb-20">
                    <header className="bg-white border-b px-4 h-16 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                        <div className="flex items-center gap-3">
                            <img src={store.logoUrl} className="w-10 h-10 rounded-lg bg-slate-100 object-cover"/>
                            <div>
                                <div className="font-bold text-sm text-slate-900 leading-tight">{store.name}</div>
                                <div className={`text-[10px] font-bold uppercase flex items-center gap-1 ${store.paymentStatus==='active'?'text-green-600':'text-amber-600'}`}>
                                    <span className={`w-2 h-2 rounded-full ${store.paymentStatus==='active'?'bg-green-500':'bg-amber-500'}`}></span>
                                    {store.paymentStatus==='active'?'Loja Online':'Aguardando Pagamento'}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            {store.paymentStatus==='active' && <button onClick={()=>navigate('storefront', store.id)} className="text-slate-600 hover:bg-slate-100 px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-2 transition"><ExternalLink size={14}/> Ver Loja</button>}
                            <button onClick={()=>signOut(auth)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><LogOut size={18}/></button>
                        </div>
                    </header>
                    
                    <main className="max-w-3xl mx-auto px-4 py-8">
                        <div className="flex gap-2 mb-8 overflow-x-auto pb-2 scrollbar-hide">
                            {[{id:'products', l:'Produtos', i:Package},{id:'sub', l:'Assinatura', i:Wallet},{id:'settings', l:'Configura√ß√µes', i:Settings}].map(t => (
                                <button key={t.id} onClick={()=>setTab(t.id)} className={`px-5 py-2.5 rounded-full text-sm font-bold whitespace-nowrap transition flex items-center gap-2 ${tab===t.id ? 'bg-slate-900 text-white shadow-lg shadow-slate-900/20' : 'bg-white text-slate-500 border border-slate-200 hover:bg-slate-50'}`}>
                                    <t.i size={16}/> {t.l}
                                </button>
                            ))}
                        </div>

                        {tab === 'products' && (
                            <div className="animate-fade-in">
                                {store.paymentStatus!=='active' ? (
                                    <div className="text-center p-10 bg-white rounded-3xl border border-slate-200 shadow-sm">
                                        <div className="w-16 h-16 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4"><Lock size={32}/></div>
                                        <h3 className="font-bold text-xl text-slate-900">Loja Bloqueada</h3>
                                        <p className="text-slate-500 text-sm mb-6 mt-2">Realize o pagamento da assinatura para come√ßar a vender.</p>
                                        <button onClick={()=>setTab('sub')} className="text-white bg-amber-500 px-6 py-2 rounded-xl font-bold shadow-lg shadow-amber-200 hover:bg-amber-600 transition">Ir para Pagamento</button>
                                    </div>
                                ) : (
                                    <>
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-lg font-bold text-slate-800">Seu Cat√°logo</h2>
                                            <button onClick={()=>setAdding(!adding)} className="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-sm flex items-center gap-2 shadow-lg hover:bg-slate-800 transition">
                                                {adding ? <X size={16}/> : <Plus size={16}/>} {adding ? 'Cancelar' : 'Adicionar'}
                                            </button>
                                        </div>
                                        
                                        {adding && (
                                            <form onSubmit={saveProduct} className="bg-white p-6 rounded-2xl shadow-xl mb-8 animate-slide-up border border-slate-100 relative overflow-hidden">
                                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                                                <div className="grid grid-cols-2 gap-4 mb-6">
                                                    <div className="col-span-2">
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">Nome do Produto</label>
                                                        <input required className="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-blue-500 transition" value={newProd.name} onChange={e=>setNewProd({...newProd, name:e.target.value})}/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">Pre√ßo (R$)</label>
                                                        <input required type="number" step="0.01" className="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-blue-500 transition" value={newProd.price} onChange={e=>setNewProd({...newProd, price:e.target.value})}/>
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">Imagem (URL)</label>
                                                        <input className="w-full border border-slate-200 p-3 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-blue-500 transition" placeholder="Opcional" value={newProd.img} onChange={e=>setNewProd({...newProd, img:e.target.value})}/>
                                                    </div>
                                                </div>
                                                <button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">Salvar Produto</button>
                                            </form>
                                        )}

                                        <div className="space-y-3">
                                            {products.map(p => (
                                                <div key={p.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-4 hover:shadow-md transition group">
                                                    <div className="w-16 h-16 rounded-lg bg-slate-100 overflow-hidden shrink-0">
                                                        <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-500"/>
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-bold text-slate-900 truncate">{p.name}</div>
                                                        <div className="text-green-600 font-bold text-sm">{formatBRL(p.price)}</div>
                                                    </div>
                                                    <button onClick={()=>deleteProduct(p.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 size={18}/></button>
                                                </div>
                                            ))}
                                            {products.length===0 && !adding && <div className="text-center text-slate-400 py-12 bg-white rounded-2xl border border-dashed border-slate-300">Sua loja ainda n√£o tem produtos.</div>}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {tab === 'sub' && (
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 animate-fade-in max-w-lg mx-auto">
                                <div className="text-center mb-8">
                                    <div className="w-14 h-14 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 shadow-inner"><Wallet size={28}/></div>
                                    <h2 className="font-bold text-2xl text-slate-900">Assinatura</h2>
                                    <p className="text-sm text-slate-500 mt-1">Status Atual: <span className={`font-bold px-2 py-0.5 rounded ${store.paymentStatus==='active'?'bg-green-100 text-green-700':'bg-amber-100 text-amber-700'}`}>{store.paymentStatus==='active'?'ATIVA':'PENDENTE'}</span></p>
                                </div>
                                
                                <div className="bg-slate-50 p-6 rounded-2xl border border-slate-200 mb-6">
                                    <p className="text-xs font-bold text-slate-400 uppercase mb-3 text-center tracking-wide">Chave Pix para Pagamento</p>
                                    <div onClick={()=>{copyText(pixKey); showToast("Copiado!");}} className="group bg-white border-2 border-blue-100 p-4 rounded-xl text-center font-mono font-bold text-slate-700 cursor-pointer hover:border-blue-400 hover:text-blue-600 transition flex items-center justify-center gap-3 relative overflow-hidden">
                                        <span className="z-10 truncate">{pixKey || "Aguardando Admin"}</span> <Copy size={16} className="z-10"/>
                                        <div className="absolute inset-0 bg-blue-50 opacity-0 group-hover:opacity-100 transition"></div>
                                    </div>
                                    <p className="text-[10px] text-center text-slate-400 mt-2">Clique para copiar</p>
                                </div>
                                
                                <div className="text-center">
                                    <p className="text-sm text-slate-600 bg-amber-50 p-4 rounded-xl border border-amber-100 inline-block">
                                        <span className="font-bold">Instru√ß√µes:</span> Realize o pagamento via Pix e envie o comprovante para o administrador para liberar sua loja.
                                    </p>
                                </div>
                            </div>
                        )}

                        {tab === 'settings' && (
                            <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 animate-fade-in max-w-lg mx-auto">
                                <h2 className="font-bold text-xl mb-6 text-slate-900">Configura√ß√µes da Loja</h2>
                                <form onSubmit={saveSettings} className="space-y-5">
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">Nome da Loja</label>
                                        <input name="name" defaultValue={store.name} className="w-full border border-slate-200 p-3 rounded-xl outline-none focus:border-blue-500 transition"/>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">WhatsApp (Apenas n√∫meros)</label>
                                        <div className="flex items-center border border-slate-200 rounded-xl overflow-hidden focus-within:border-blue-500 transition">
                                            <div className="bg-slate-100 px-3 py-3 border-r border-slate-200 text-slate-500"><MessageCircle size={18}/></div>
                                            <input name="whatsapp" defaultValue={store.whatsapp} placeholder="5511999999999" className="w-full p-3 outline-none"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase ml-1">Cor da Marca</label>
                                        <div className="flex items-center gap-4 mt-2 bg-slate-50 p-3 rounded-xl border border-slate-200">
                                            <input name="color" type="color" defaultValue={store.themeColor} className="h-10 w-10 rounded-lg cursor-pointer border-none bg-transparent"/>
                                            <span className="text-sm text-slate-500">Escolha a cor principal do site</span>
                                        </div>
                                    </div>
                                    <button className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold mt-4 shadow-lg hover:bg-slate-800 transition">Salvar Altera√ß√µes</button>
                                </form>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // --- 4. STOREFRONT (LOJA P√öBLICA) - RTDB ---
        function Storefront({ storeId, navigate, showToast }) {
            const [store, setStore] = useState(null);
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);
            const [cartOpen, setCartOpen] = useState(false);
            const [checkoutData, setCheckoutData] = useState({name:'', method:'Pix'});

            useEffect(() => {
                if(!storeId) return;
                const storeRef = ref(db, `artifacts/${APP_ID}/public/data/stores/${storeId}`);
                const unsub1 = onValue(storeRef, (snap) => {
                    if (snap.exists()) setStore({id: snap.key, ...snap.val()});
                });

                const productsRef = ref(db, `artifacts/${APP_ID}/public/data/products`);
                const q = query(productsRef, orderByChild('storeId'), equalTo(storeId));
                const unsub2 = onValue(q, (snap) => setProducts(snapshotToArray(snap)));

                return () => { unsub1(); unsub2(); };
            }, [storeId]);

            const addToCart = (p) => { setCart([...cart, p]); showToast("Adicionado √† sacola!"); setCartOpen(true); };
            const removeFromCart = (i) => setCart(cart.filter((_,idx)=>idx!==i));
            const total = cart.reduce((a,b) => a+b.price, 0);
            
            const finish = () => {
                if(!store.whatsapp) return showToast("Esta loja n√£o configurou o WhatsApp.", "error");
                if(!checkoutData.name) return showToast("Por favor, digite seu nome.", "error");
                
                let msg = `*PEDIDO - ${store.name.toUpperCase()}* üõçÔ∏è\n`;
                msg += `--------------------------------\n`;
                msg += `üë§ *Cliente:* ${checkoutData.name}\n`;
                msg += `üí≥ *Pagamento:* ${checkoutData.method}\n`;
                msg += `--------------------------------\n`;
                cart.forEach(item => { msg += `üì¶ 1x ${item.name} ‚Ä¢ ${formatBRL(item.price)}\n` });
                msg += `--------------------------------\n`;
                msg += `üí∞ *TOTAL: ${formatBRL(total)}*`;
                
                window.open(`https://wa.me/${store.whatsapp}?text=${encodeURIComponent(msg)}`);
                setCart([]); setCartOpen(false);
            };

            if(!store) return <div className="h-screen flex items-center justify-center bg-slate-50"><div className="animate-spin w-10 h-10 border-4 border-slate-200 border-t-slate-900 rounded-full"></div></div>;
            
            const brandColor = store.themeColor || "#1e293b";

            return (
                <div className="min-h-screen bg-slate-50 font-sans">
                    <div className="sticky top-0 z-30 bg-white shadow-[0_4px_20px_-10px_rgba(0,0,0,0.1)] px-4 h-20 flex items-center justify-between transition-all">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 rounded-full p-0.5 border-2 border-slate-100 overflow-hidden bg-white">
                                <img src={store.logoUrl} className="w-full h-full object-cover rounded-full"/>
                            </div>
                            <div>
                                <h1 className="font-bold text-slate-900 leading-tight text-lg">{store.name}</h1>
                                <p className="text-xs text-green-600 font-bold flex items-center gap-1"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Aberto agora</p>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={()=>navigate('landing')} className="p-3 bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200 transition"><X size={20}/></button>
                            <button onClick={()=>setCartOpen(true)} className="relative p-3 bg-slate-100 rounded-full text-slate-800 hover:bg-slate-200 transition group">
                                <ShoppingBag size={20}/>
                                {cart.length>0 && <span style={{backgroundColor:brandColor}} className="absolute -top-1 -right-1 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full font-bold border-2 border-white animate-bounce">{cart.length}</span>}
                            </button>
                        </div>
                    </div>

                    <div style={{backgroundColor: brandColor}} className="h-40 w-full relative overflow-hidden">
                        <div className="absolute inset-0 bg-black/20"></div>
                        <div className="absolute bottom-0 left-0 w-full h-20 bg-gradient-to-t from-slate-50 to-transparent"></div>
                    </div>

                    <div className="px-4 -mt-20 pb-20 max-w-5xl mx-auto relative z-10">
                        {products.length > 0 ? (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                {products.map(p => (
                                    <div key={p.id} className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-full hover:shadow-xl transition duration-300 transform hover:-translate-y-1 group">
                                        <div className="h-56 bg-slate-100 relative overflow-hidden">
                                            <img src={p.image} className="w-full h-full object-cover group-hover:scale-110 transition duration-700"/>
                                            <div className="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition"></div>
                                        </div>
                                        <div className="p-5 flex flex-col flex-1">
                                            <h3 className="font-bold text-slate-800 mb-1 text-lg leading-tight">{p.name}</h3>
                                            <div className="mt-auto pt-4 border-t border-slate-50 flex justify-between items-center">
                                                <span className="font-bold text-xl text-slate-900">{formatBRL(p.price)}</span>
                                                <button onClick={()=>addToCart(p)} style={{backgroundColor: brandColor}} className="text-white p-3 rounded-xl shadow-lg active:scale-95 transition hover:opacity-90"><Plus size={20}/></button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="bg-white p-12 rounded-3xl text-center shadow-sm border border-slate-200">
                                <ShoppingBag className="mx-auto text-slate-300 mb-4" size={48}/>
                                <p className="text-slate-500 font-medium">Nenhum produto dispon√≠vel no momento.</p>
                            </div>
                        )}
                    </div>

                    {/* Carrinho Slide-over */}
                    {cartOpen && (
                        <div className="fixed inset-0 z-50 flex justify-end isolate">
                            <div className="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onClick={()=>setCartOpen(false)}></div>
                            <div className="w-full max-w-md bg-white z-10 shadow-2xl flex flex-col h-full animate-slide-in-right">
                                <div className="p-5 border-b flex justify-between items-center bg-slate-50">
                                    <h2 className="font-bold text-xl flex items-center gap-2 text-slate-800"><ShoppingBag size={22}/> Sua Sacola</h2>
                                    <button onClick={()=>setCartOpen(false)} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition"><X size={22}/></button>
                                </div>
                                
                                {checkoutStep === 'cart' ? (
                                    <>
                                    <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-white">
                                        {cart.length===0 ? (
                                            <div className="flex flex-col items-center justify-center h-full text-slate-400 gap-4 opacity-60">
                                                <ShoppingBag size={64} strokeWidth={1}/>
                                                <p>Sua sacola est√° vazia.</p>
                                            </div>
                                        ) : 
                                        cart.map((item, i) => (
                                            <div key={i} className="flex gap-4 p-3 border border-slate-100 rounded-2xl items-center shadow-sm bg-white">
                                                <img src={item.image} className="w-16 h-16 rounded-xl object-cover bg-slate-100"/>
                                                <div className="flex-1">
                                                    <div className="font-bold text-slate-900 text-sm line-clamp-1">{item.name}</div>
                                                    <div className="text-xs text-slate-500 font-medium mt-1">{formatBRL(item.price)}</div>
                                                </div>
                                                <button onClick={()=>removeFromCart(i)} className="text-slate-300 hover:text-red-500 p-2 transition"><Trash2 size={18}/></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-6 border-t bg-slate-50 shadow-[0_-4px_20px_-10px_rgba(0,0,0,0.05)]">
                                        <div className="flex justify-between font-bold text-xl mb-6 text-slate-900"><span>Total</span><span>{formatBRL(total)}</span></div>
                                        <button disabled={cart.length===0} onClick={()=>setCheckoutStep('details')} style={{backgroundColor: brandColor}} className="w-full text-white py-4 rounded-xl font-bold shadow-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed text-lg">
                                            Finalizar Pedido
                                        </button>
                                    </div>
                                    </>
                                ) : (
                                    <div className="flex-1 p-8 flex flex-col gap-6 bg-white">
                                        <div className="bg-emerald-50 border border-emerald-100 p-4 rounded-2xl text-emerald-800 text-sm font-bold flex items-start gap-3">
                                            <ShieldCheck size={20} className="shrink-0 mt-0.5"/> 
                                            <div>
                                                <p className="mb-1 text-base">Pagamento Seguro</p>
                                                <p className="text-xs font-normal text-emerald-700">O pagamento √© combinado diretamente com o vendedor (Pix, Dinheiro ou Cart√£o na entrega).</p>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-5">
                                            <div>
                                                <label className="block text-xs font-bold uppercase text-slate-400 mb-1 ml-1">Seu Nome</label>
                                                <input className="w-full border border-slate-200 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-blue-500 transition" placeholder="Ex: Maria Silva" value={checkoutData.name} onChange={e=>setCheckoutData({...checkoutData, name:e.target.value})} autoFocus/>
                                            </div>
                                            <div>
                                                <label className="block text-xs font-bold uppercase text-slate-400 mb-1 ml-1">Forma de Pagamento</label>
                                                <div className="relative">
                                                    <select className="w-full border border-slate-200 p-4 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-blue-500 appearance-none transition cursor-pointer" value={checkoutData.method} onChange={e=>setCheckoutData({...checkoutData, method:e.target.value})}>
                                                        <option value="Pix">Pagamento via Pix</option>
                                                        <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                                                        <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                                                        <option value="Dinheiro">Pagamento em Dinheiro</option>
                                                    </select>
                                                    <ChevronRight className="absolute right-4 top-4 text-slate-400 rotate-90 pointer-events-none" size={20}/>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mt-auto pt-6">
                                            <button onClick={finish} className="w-full bg-[#25D366] hover:bg-[#20bd5a] text-white py-4 rounded-xl font-bold shadow-lg flex items-center justify-center gap-3 transition text-lg shadow-green-200/50">
                                                <MessageCircle size={24}/> Enviar no WhatsApp
                                            </button>
                                            <button onClick={()=>setCheckoutStep('cart')} className="w-full text-slate-400 hover:text-slate-600 font-bold text-sm mt-4 py-2">Voltar para sacola</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- 5. DIRET√ìRIO (RTDB) ---
        function Directory({ navigate }) {
            const [stores, setStores] = useState([]);
            const [term, setTerm] = useState('');

            useEffect(() => {
                const storesRef = ref(db, `artifacts/${APP_ID}/public/data/stores`);
                const unsub = onValue(storesRef, (snap) => {
                    setStores(snapshotToArray(snap));
                });
                return () => unsub();
            }, []);

            const filtered = stores.filter(s => s.name.toLowerCase().includes(term.toLowerCase()));

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex items-center gap-4 mb-10">
                            <button onClick={()=>navigate('landing')} className="bg-white p-3 rounded-full shadow-sm hover:bg-slate-100 border border-slate-200 transition text-slate-500"><ChevronRight className="rotate-180"/></button>
                            <div>
                                <h1 className="text-3xl font-bold text-slate-900">Diret√≥rio de Lojas</h1>
                                <p className="text-slate-500">Encontre produtos incr√≠veis perto de voc√™.</p>
                            </div>
                        </div>
                        
                        <div className="relative mb-10">
                            <Search className="absolute left-5 top-4 text-slate-400" size={20}/>
                            <input className="w-full pl-14 pr-6 py-4 rounded-2xl border-none shadow-sm focus:ring-2 ring-blue-500 outline-none text-lg" placeholder="Buscar pelo nome da loja..." value={term} onChange={e=>setTerm(e.target.value)}/>
                        </div>

                        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filtered.map(s => (
                                <div key={s.id} onClick={()=>navigate('storefront', s.id)} className="bg-white p-6 rounded-3xl shadow-sm hover:shadow-xl transition cursor-pointer border border-slate-100 flex items-center gap-5 group hover:-translate-y-1 duration-300">
                                    <div className="w-16 h-16 rounded-2xl bg-slate-100 overflow-hidden shrink-0 border border-slate-100">
                                        <img src={s.logoUrl} className="w-full h-full object-cover group-hover:scale-110 transition duration-500"/>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg text-slate-900 group-hover:text-blue-600 transition">{s.name}</h3>
                                        <div className="flex items-center gap-2 text-xs font-bold mt-1">
                                            {s.paymentStatus==='active' ? 
                                                <span className="text-green-600 bg-green-50 px-2 py-0.5 rounded-md flex items-center gap-1"><CheckCircle2 size={12}/> Verificado</span> : 
                                                <span className="text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md">Novo</span>
                                            }
                                        </div>
                                    </div>
                                    <div className="ml-auto text-slate-300 group-hover:text-blue-500 transition"><ChevronRight/></div>
                                </div>
                            ))}
                            {filtered.length === 0 && <div className="col-span-full text-center py-20 text-slate-400">Nenhuma loja encontrada.</div>}
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
